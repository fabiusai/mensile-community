<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizzatore Community</title>
    
    <link rel="icon" href="favicon.ico">

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <style>
        /*
         * STILI PERSONALIZZATI
         * Colori: Giallo (#eddc01) e Blu (#0146bc)
        */
        :root {
            --brand-blue: #0146bc;
            --brand-yellow: #eddc01;
            --brand-dark-blue: #002b5c; /* Blu più scuro per testo e accenti */
            /* I colori dei grafici sono ora hard-coded in JS per compatibilità SVG */
            --brand-light-grey: #f4f7f6; /* Sfondo pagina */
            --brand-text: #333333;
            /* --- MODIFICA: Colore testo più chiaro --- */
            /* 1) MODIFICA: Colore testo scurito */
            --chart-text-grey: #666666; /* Era #B0B0B0 */
        }

        body {
            font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--brand-light-grey);
            color: var(--brand-text);
        }

        /* Stile Header */
        .app-header {
            background-color: var(--brand-blue);
            border-bottom: 4px solid var(--brand-yellow);
        }

        /* Stile Bottoni Principali (Upload/Download) */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem; /* 12px 24px */
            border-radius: 0.375rem; /* 6px */
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 2px solid transparent;
            /* Design flat */
            box-shadow: none;
        }

        .btn-primary {
            background-color: var(--brand-blue);
            color: white;
            border-color: var(--brand-blue);
        }
        .btn-primary:hover {
            background-color: var(--brand-dark-blue);
            border-color: var(--brand-dark-blue);
            color: var(--brand-yellow);
        }
        .btn-primary:disabled {
            background-color: #a0aec0; /* grigio */
            cursor: not-allowed;
        }

        /* Bottoni Secondari (Download) */
        .btn-secondary {
            background-color: white;
            color: var(--brand-blue);
            border-color: var(--brand-blue);
        }
        .btn-secondary:hover {
            background-color: var(--brand-blue);
            color: white;
        }
        .btn-secondary:disabled {
            background-color: #e2e8f0; /* grigio chiaro */
            border-color: #cbd5e0;
            color: #a0aec0;
            cursor: not-allowed;
        }

        /* Stile Tabs */
        .tab-button {
            padding: 0.5rem 1.25rem; /* 8px 20px */
            font-weight: 700;
            border-radius: 9999px; /* pill */
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: var(--brand-yellow);
            color: var(--brand-dark-blue);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .tab-button:not(.active) {
            background-color: #e2e8f0; /* grigio chiaro */
            color: var(--brand-dark-blue);
        }
        .tab-button:not(.active):hover {
            background-color: #cbd5e0; /* grigio medio */
        }
        
        /* Stile per i grafici per compatibilità SVG */
        .apexcharts-svg {
            background-color: transparent !important; /* Fix per sfondi SVG */
        }
        
        /* Nasconde l'input file originale */
        input[type="file"].hidden-input {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }
        
        /* Animazione di fade-in per i contenuti */
        .content-section {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .content-section.visible {
            display: block;
        }
        
        /* Stili Tabella Dati */
        .data-table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }

    </style>
</head>
<body class="antialiased">

    <header class="app-header py-5 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h1 class="text-3xl font-bold text-white tracking-wide">
                Analizzatore Report
            </h1>
            <p class="text-lg text-gray-200">Carica un file Excel per generare i grafici</p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-8 space-y-8">

        <section class="bg-white rounded-lg shadow-lg p-6 md:p-8 border-t-4 border-brand-yellow">
            <h2 class="text-2xl font-bold text-brand-dark-blue mb-5 pb-3 border-b border-gray-200">
                1. Carica il tuo file Excel
            </h2>
            
            <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                <label for="fileInput" id="uploadButtonLabel" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.33-2.33 4.5 4.5 0 01-1.41 8.775" />
                    </svg>
                    <span id="uploadButtonText">Seleziona file Excel</span>
                </label>
                
                <input type="file" id="fileInput" accept=".xlsx, .xls" class="hidden-input">
                
                <span id="fileName" class="text-gray-600 font-medium italic">Nessun file selezionato.</span>
            </div>

            <div id="errorMessage" class="hidden mt-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert">
                <p class="font-bold">Errore</p>
                <p id="errorText">Si è verificato un problema.</p>
            </div>
        </section>

        <section id="summarySection" class="content-section bg-white rounded-lg shadow-lg p-6 md:p-8">
            <h2 class="text-2xl font-bold text-brand-dark-blue mb-5 pb-3 border-b border-gray-200">
                Commenti Complessivi (Attività Utenti)
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 text-center">
                
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Poste Italiane</h4>
                    <div class="flex items-center justify-center gap-2 mt-1">
                        <p id="summaryPI" class="text-3xl font-bold text-brand-dark-blue">-</p>
                        <button id="copySummaryPI" title="Copia valore" class="copy-summary-btn text-gray-400 hover:text-brand-blue transition-colors duration-150 p-1 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 8.25V6a2.25 2.25 0 00-2.25-2.25H6A2.25 2.25 0 003.75 6v8.25A2.25 2.25 0 006 16.5h2.25m8.25-8.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-7.5A2.25 2.25 0 018.25 18v-1.5m8.25-8.25h-6.75" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Postepay</h4>
                    <div class="flex items-center justify-center gap-2 mt-1">
                        <p id="summaryPP" class="text-3xl font-bold text-brand-dark-blue">-</p>
                        <button id="copySummaryPP" title="Copia valore" class="copy-summary-btn text-gray-400 hover:text-brand-blue transition-colors duration-150 p-1 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 8.25V6a2.25 2.25 0 00-2.25-2.25H6A2.25 2.25 0 003.75 6v8.25A2.25 2.25 0 006 16.5h2.25m8.25-8.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-7.5A2.25 2.25 0 018.25 18v-1.5m8.25-8.25h-6.75" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">PosteMobile</h4>
                    <div class="flex items-center justify-center gap-2 mt-1">
                        <p id="summaryPM" class="text-3xl font-bold text-brand-dark-blue">-</p>
                        <button id="copySummaryPM" title="Copia valore" class="copy-summary-btn text-gray-400 hover:text-brand-blue transition-colors duration-150 p-1 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 8.25V6a2.25 2.25 0 00-2.25-2.25H6A2.25 2.25 0 003.75 6v8.25A2.25 2.25 0 006 16.5h2.25m8.25-8.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-7.5A2.25 2.25 0 018.25 18v-1.5m8.25-8.25h-6.75" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="bg-brand-yellow p-4 rounded-lg">
                    <h4 class="text-sm font-bold text-brand-dark-blue uppercase tracking-wider">TOTALE</h4>
                    <div class="flex items-center justify-center gap-2 mt-1">
                        <p id="summaryOverall" class="text-3xl font-bold text-brand-dark-blue">-</p>
                        <button id="copySummaryOverall" title="Copia valore" class="copy-summary-btn text-brand-dark-blue hover:text-brand-blue/70 transition-colors duration-150 p-1 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 8.25V6a2.25 2.25 0 00-2.25-2.25H6A2.25 2.25 0 003.75 6v8.25A2.25 2.25 0 006 16.5h2.25m8.25-8.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-7.5A2.25 2.25 0 018.25 18v-1.5m8.25-8.25h-6.75" />
                            </svg>
                        </button>
                    </div>
                </div>
                
            </div>
        </section>
        <section id="controls" class="content-section bg-white rounded-lg shadow-lg p-6 md:p-8">
            <h2 class="text-2xl font-bold text-brand-dark-blue mb-5 pb-3 border-b border-gray-200">
                2. Seleziona la Pagina
            </h2>
            <div id="tabsContainer" class="flex flex-wrap gap-3">
                </div>
        </section>

        <section id="chartsContainerWrapper" class="content-section bg-white rounded-lg shadow-lg p-6 md:p-8">
            <h2 class="text-2xl font-bold text-brand-dark-blue mb-5 pb-3 border-b border-gray-200">
                3. Visualizza i Grafici
            </h2>
            
            <div id="chartsContainer" class="space-y-16">
                
                <div>
                    <h3 id="bar-chart-title" class="text-xl font-semibold text-brand-dark-blue mb-3 text-center"></h3>
                    <div class="mx-auto" style="width: 90%; max-width: 800px;">
                         <div id="chart-bar-wrapper">
                             <div id="chart-bar"></div>
                         </div>
                    </div>
                </div>
                
                <div>
                    <h3 id="donut-chart-title" class="text-xl font-semibold text-brand-dark-blue mb-1 text-center"></h3>
                    <div class="mx-auto" style="width: 100%; max-width: 450px;">
                         <div id="chart-donut-wrapper">
                             <div id="chart-donut"></div>
                         </div>
                    </div>
                </div>
                
            </div>
        </section>

        <section id="tableContainerWrapper" class="content-section bg-white rounded-lg shadow-lg p-6 md:p-8">
            <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-5 pb-3 border-b border-gray-200">
                <h2 id="tableTitle" class="text-2xl font-bold text-brand-dark-blue">
                    Dettaglio Argomenti
                </h2>
                <button id="copyTableButton" class="btn btn-secondary mt-3 sm:mt-0">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 8.25V6a2.25 2.25 0 00-2.25-2.25H6A2.25 2.25 0 003.75 6v8.25A2.25 2.25 0 006 16.5h2.25m8.25-8.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-7.5A2.25 2.25 0 018.25 18v-1.5m8.25-8.25h-6.75" />
                    </svg>
                    <span class="btn-text">Copia Tabella</span>
                </button>
            </div>
            
            <div class="overflow-y-auto max-h-[600px] border border-gray-200 rounded-lg">
                <div id="tableContainer">
                    </div>
            </div>
        </section>


        <section id="downloadButtons" class="content-section bg-white rounded-lg shadow-lg p-6 md:p-8">
             <h2 class="text-2xl font-bold text-brand-dark-blue mb-5 pb-3 border-b border-gray-200">
                4. Esporta Grafici
            </h2>
            <div class="flex flex-wrap gap-4">
                <button id="downloadBarBtn" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    <span class="btn-text">Scarica Grafico a Barre (PNG)</span>
                </button>
                
                <button id="downloadDonutBtn" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    <span class="btn-text">Scarica Grafico a Torta (PNG)</span>
                </button>
                
            </div>
        </section>

    </main>

<script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Selettori DOM ---
            const fileInput = document.getElementById('fileInput');
            const fileName = document.getElementById('fileName');
            const uploadButtonLabel = document.getElementById('uploadButtonLabel');
            const uploadButtonText = document.getElementById('uploadButtonText');
            
            const controlsSection = document.getElementById('controls');
            const tabsContainer = document.getElementById('tabsContainer');
            
            // Sezioni Contenuto
            const chartsSection = document.getElementById('chartsContainerWrapper');
            const downloadSection = document.getElementById('downloadButtons');
            const tableSection = document.getElementById('tableContainerWrapper'); 
            const tableContainer = document.getElementById('tableContainer'); 
            const tableTitle = document.getElementById('tableTitle'); 
            const copyTableButton = document.getElementById('copyTableButton'); 

            // Selettori per i titoli HTML
            const barChartTitle = document.getElementById('bar-chart-title');
            const donutChartTitle = document.getElementById('donut-chart-title');
            
            // 3. SELETTORI BOTTONI MODIFICATI
            const downloadBarBtn = document.getElementById('downloadBarBtn');
            const downloadDonutBtn = document.getElementById('downloadDonutBtn');
            
            // Errori
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');

            // --- INIZIO MODIFICA 1: Aggiunti selettori per Summary ---
            const summarySection = document.getElementById('summarySection');
            const summaryPI = document.getElementById('summaryPI');
            const summaryPP = document.getElementById('summaryPP');
            const summaryPM = document.getElementById('summaryPM');
            const summaryOverall = document.getElementById('summaryOverall');
            // --- FINE MODIFICA 1 ---

            // --- Stato Applicazione ---
            let workbook = null;
            let charts = {
                bar: null,
                donut: null 
            };
            let currentSheetName = null; 
            
            const targetSheets = [
                "Community Poste Italiane",
                "Community Postepay",
                "Community PosteMobile",
                "Temi trattati Poste Italiane FB" 
            ];
            
            // Colori hard-coded per compatibilità SVG e come da richiesta
            const chartColors = {
                user: '#c2d6fb',      // Azzurro/Grigio richiesto (Utenti)
                moderator: '#0146bc', // Blu scuro (Moderatori)
                /* 1) MODIFICA: Colore testo scurito */
                text: '#666666',      // Era #B0B0B0
                title: '#002b5c' 
            };

            // --- Gestione Eventi ---

            fileInput.addEventListener('change', handleFile);
            
            // 3. LISTENER EVENTI MODIFICATI
            downloadBarBtn.addEventListener('click', () => downloadPNG('chart-bar-wrapper', 'grafico_barre.png', downloadBarBtn));
            
            // --- MODIFICA 1: Aggiunto il parametro '112' per il crop ---
            downloadDonutBtn.addEventListener('click', () => downloadPNG('chart-donut-wrapper', 'grafico_torta.png', downloadDonutBtn, 112));
            
            copyTableButton.addEventListener('click', () => copyTableToClipboard('dataTable', copyTableButton)); 

            // 1) ELIMINATO: Event listener per lo slider del font

            // --- INIZIO MODIFICA (JS) 1: Listener per icone copia summary ---
            document.getElementById('copySummaryPI').addEventListener('click', (e) => copySummaryValue('summaryPI', e.currentTarget));
            document.getElementById('copySummaryPP').addEventListener('click', (e) => copySummaryValue('summaryPP', e.currentTarget));
            document.getElementById('copySummaryPM').addEventListener('click', (e) => copySummaryValue('summaryPM', e.currentTarget));
            document.getElementById('copySummaryOverall').addEventListener('click', (e) => copySummaryValue('summaryOverall', e.currentTarget));
            // --- FINE MODIFICA (JS) 1 ---

            // --- Funzioni Principali ---

            async function handleFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                setButtonLoading(uploadButtonLabel, uploadButtonText, "Caricamento...");
                fileName.textContent = file.name;
                hideError();
                resetUI();

                try {
                    const data = await file.arrayBuffer();
                    workbook = XLSX.read(data, { type: 'array' });
                    
                    setButtonDone(uploadButtonLabel, uploadButtonText, "File Caricato!", "Seleziona file Excel");
                    
                    // --- INIZIO MODIFICA 2: Chiamata alla funzione Summary ---
                    calculateAndDisplaySummary(workbook);
                    // --- FINE MODIFICA 2 ---
                    
                    setupTabs(workbook);
                    showSection(controlsSection);

                } catch (err) {
                    console.error("Errore during la lettura del file:", err);
                    showError("Impossibile leggere il file. Assicurati che sia un file Excel valido.");
                    setButtonError(uploadButtonLabel, uploadButtonText, "Errore! Riprova", "Seleziona file Excel");
                    fileName.textContent = "Nessun file selezionato.";
                }
            }
            
            function setupTabs(wb) {
                tabsContainer.innerHTML = ''; 
                let foundSheets = 0;

                targetSheets.forEach(sheetName => {
                    if (wb.SheetNames.includes(sheetName)) {
                        foundSheets++;
                        const tabButton = document.createElement('button');
                        tabButton.className = 'tab-button';
                        tabButton.textContent = sheetName;
                        
                        // Logica per mostrare grafici O tabella
                        tabButton.addEventListener('click', () => {
                            tabsContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                            tabButton.classList.add('active');
                            
                            currentSheetName = sheetName; 

                            if (sheetName.startsWith("Community")) {
                                showSection(chartsSection);
                                showSection(downloadSection);
                                hideSection(tableSection); // Nasconde la tabella
                                processSheet(wb.Sheets[sheetName], sheetName);
                            } else if (sheetName.startsWith("Temi trattati")) {
                                hideSection(chartsSection);
                                hideSection(downloadSection);
                                showSection(tableSection); // Mostra la tabella
                                processTableSheet(wb.Sheets[sheetName], sheetName);
                            }
                        });
                        
                        tabsContainer.appendChild(tabButton);
                    }
                });

                if (foundSheets === 0) {
                    showError(`Nessuno dei fogli richiesti (es. "${targetSheets[0]}") è stato trovato nel file.`);
                } else {
                    tabsContainer.querySelector('.tab-button')?.click();
                }
            }


            function processSheet(ws, sheetName) {
                const json = XLSX.utils.sheet_to_json(ws, { 
                    range: "A15:E45", 
                    header: ["A", "B", "C", "D", "E"],
                    cellDates: true 
                });

                let categories = [];
                let seriesUser = [];
                let seriesModerator = [];
                let totalUser = 0;
                let totalModerator = 0;
                
                for (let i = 0; i < json.length; i++) {
                    const row = json[i];
                    const dateValue = row['A']; 
                    
                    if (!dateValue) {
                        break; 
                    }

                    let jsDate;
                    if (dateValue instanceof Date) {
                        jsDate = dateValue;
                    } else if (typeof dateValue === 'string') {
                        jsDate = new Date(dateValue); 
                    } else if (typeof dateValue === 'number') {
                        // Converte il numero seriale di Excel
                        const excelEpoch = new Date(1899, 11, 30);
                        jsDate = new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
                    }

                    if (!jsDate || isNaN(jsDate.getTime())) {
                        console.warn("Riga saltata a causa di data non valida:", dateValue);
                        continue; 
                    }
                    
                    const formattedDate = jsDate.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
                    
                    const incoming = parseInt(row['D'], 10) || 0; 
                    const outgoing = parseInt(row['E'], 10) || 0; 

                    categories.push(formattedDate);
                    seriesUser.push(incoming);
                    seriesModerator.push(outgoing);
                    
                    totalUser += incoming;
                    totalModerator += outgoing;
                }
                
                // --- Creazione Grafico a Barre ---
                const barSeries = [
                    { name: 'Attività Utenti', data: seriesUser },
                    { name: 'Attività Moderatori', data: seriesModerator }
                ];
                
                barChartTitle.textContent = `Volumi Giornalieri: ${sheetName}`;
                charts.bar = createBarChart('chart-bar', barSeries, categories);
                
                // --- Creazione Grafico Donut ---
                const donutSeries = [totalUser, totalModerator];
                // L'ordine delle etichette deve corrispondere ai colori (Utenti=user, Moderatori=moderator)
                const donutLabels = ['Utenti', 'Moderatori Poste']; 
                
                donutChartTitle.textContent = `Riepilogo Totale: ${sheetName}`;
                charts.donut = createDonutChart('chart-donut', donutSeries, donutLabels);

            }
            
            // Funzione per processare la tabella Argomenti
            function processTableSheet(ws, sheetName) {
                // Legge i dati da A15 in giù
                const json = XLSX.utils.sheet_to_json(ws, { 
                    range: "A15:B50", // Range ampio per sicurezza
                    header: ["Argomento", "Valore"],
                });

                tableTitle.textContent = `Dettaglio Argomenti: ${sheetName}`;

                let tableHtml = `<table id="dataTable" class="data-table w-full text-left border-collapse">
                                    <thead>
                                        <tr class="bg-gray-100 border-b-2 border-brand-blue">
                                            <th class="p-3 text-sm font-bold text-brand-dark-blue uppercase">Argomento</th>
                                            <th class="p-3 text-sm font-bold text-brand-dark-blue uppercase text-right">Valore</th>
                                        </tr>
                                    </thead>
                                    <tbody>`;
                
                let total = 0;
                json.forEach(row => {
                    const argomento = row['Argomento'];
                    const valore = parseInt(row['Valore'], 10) || 0;
                    if (argomento && valore > 0) { // Salta righe vuote o con valore 0
                        tableHtml += `<tr class="border-b border-gray-200 hover:bg-gray-50">
                                        <td class="p-3">${argomento}</td>
                                        <td class="p-3 text-right font-medium">${valore.toLocaleString('it-IT')}</td>
                                      </tr>`;
                        total += valore;
                    }
                });

                // Riga Totale
                tableHtml += `<tr class="bg-gray-200 border-t-2 border-brand-dark-blue">
                                <td class="p-3 font-bold text-brand-dark-blue">TOTALE</td>
                                <td class="p-3 text-right font-bold text-brand-dark-blue">${total.toLocaleString('it-IT')}</td>
                              </tr>`;

                tableHtml += `</tbody></table>`;
                tableContainer.innerHTML = tableHtml;
            }

            // --- INIZIO MODIFICA 3: Aggiunte funzioni per Summary ---
            function calculateSheetTotal(ws) {
                // Usa la stessa logica di processSheet per estrarre i dati
                const json = XLSX.utils.sheet_to_json(ws, { 
                    range: "A15:E45", 
                    header: ["A", "B", "C", "D", "E"],
                    cellDates: true 
                });

                let totalUser = 0;
                
                for (let i = 0; i < json.length; i++) {
                    const row = json[i];
                    const dateValue = row['A']; 
                    
                    // Stessa logica di stop di processSheet
                    if (!dateValue) {
                        break; 
                    }
                    
                    // Controllo validità data (necessario per saltare righe non valide)
                    let jsDate;
                    if (dateValue instanceof Date) {
                        jsDate = dateValue;
                    } else if (typeof dateValue === 'string') {
                        jsDate = new Date(dateValue); 
                    } else if (typeof dateValue === 'number') {
                        // Converte il numero seriale di Excel
                        const excelEpoch = new Date(1899, 11, 30);
                        jsDate = new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
                    }

                    if (!jsDate || isNaN(jsDate.getTime())) {
                        continue; 
                    }

                    // Somma solo la colonna 'D' (Attività Utenti)
                    totalUser += (parseInt(row['D'], 10) || 0);
                }
                return totalUser;
            }

            function calculateAndDisplaySummary(wb) {
                const summarySheets = {
                    "Community Poste Italiane": 0,
                    "Community Postepay": 0,
                    "Community PosteMobile": 0
                };

                let overallTotal = 0;

                // Calcola i totali per i fogli specifici
                for (const sheetName in summarySheets) {
                    if (wb.SheetNames.includes(sheetName)) {
                        const total = calculateSheetTotal(wb.Sheets[sheetName]);
                        summarySheets[sheetName] = total;
                        overallTotal += total;
                    }
                }
                
                // Popola i campi HTML usando la kFormatter esistente
                summaryPI.textContent = kFormatter(summarySheets["Community Poste Italiane"]);
                summaryPP.textContent = kFormatter(summarySheets["Community Postepay"]);
                summaryPM.textContent = kFormatter(summarySheets["Community PosteMobile"]);
                summaryOverall.textContent = kFormatter(overallTotal);
                
                // Mostra la sezione
                showSection(summarySection);
            }
            // --- FINE MODIFICA 3 ---

            function resetUI() {
                // --- INIZIO MODIFICA 4: Reset UI per Summary ---
                hideSection(controlsSection);
                hideSection(chartsSection);
                hideSection(downloadSection);
                hideSection(tableSection); 
                hideSection(summarySection); // Aggiunto
                
                // Reset testi summary
                summaryPI.textContent = '-';
                summaryPP.textContent = '-';
                summaryPM.textContent = '-';
                summaryOverall.textContent = '-';
                // --- FINE MODIFICA 4 ---
                
                if (charts.bar) charts.bar.destroy();
                if (charts.donut) charts.donut.destroy(); 
                charts.bar = null;
                charts.donut = null; 
                
                tabsContainer.innerHTML = '';
                tableContainer.innerHTML = ''; 
                currentSheetName = null;
            }

            // Funzione kFormatter aggiornata per gestire `,0`
            // QUESTA FUNZIONE SODDISFA GIA' I REQUISITI (es. 1,5k e 2k)
            function kFormatter(value) {
                const num = parseFloat(value);
                if (isNaN(num)) return value; // Gestione sicurezza

                if (num >= 1000) {
                    let kNum = num / 1000;
                    // Formatta con max 1 decimale, usa virgola (es. 1,5k o 1k)
                    return kNum.toLocaleString('it-IT', { maximumFractionDigits: 1 }) + 'k';
                }
                // Formatta come intero (es. 950)
                return num.toLocaleString('it-IT', { maximumFractionDigits: 0 }); 
            }


            // --- Funzioni di Creazione Grafici ---

            function createBarChart(elementId, series, categories) {
                if (charts.bar) charts.bar.destroy();
                document.getElementById(elementId).innerHTML = '';
                const options = getBarChartOptions(series, categories);
                const chart = new ApexCharts(document.getElementById(elementId), options);
                chart.render();
                return chart;
            }
            
            function createDonutChart(elementId, series, labels) {
                if (charts.donut) charts.donut.destroy();
                document.getElementById(elementId).innerHTML = '';
                const options = getDonutChartOptions(series, labels);
                const chart = new ApexCharts(document.getElementById(elementId), options);
                chart.render();
                return chart;
            }

            function getBarChartOptions(series, categories) {
                return {
                    series: series,
                    chart: {
                        type: 'bar',
                        height: 470,
                        width: '100%', 
                        stacked: true, 
                        toolbar: { show: false },
                        fontFamily: 'Nunito Sans, sans-serif'
                    },
                    colors: [chartColors.user, chartColors.moderator],
                    plotOptions: {
                        bar: {
                            horizontal: false,
                            columnWidth: '90%', 
                        }
                    },
                    dataLabels: {
                        enabled: false 
                    },
                    xaxis: {
                        categories: categories,
                        labels: {
                            style: {
                                colors: chartColors.text, /* MODIFICA: Usa colore scurito */
                                fontSize: '30px', 
                                fontWeight: 400
                            },
                            offsetY: 15,
                            rotate: -45,
                            rotateAlways: true
                        },
                        tickAmount: categories.length > 5 ? Math.floor(categories.length / 3) : undefined,
                        tickPlacement: 'on'
                    },
                    yaxis: {
                         labels: {
                            style: {
                                colors: chartColors.text, /* MODIFICA: Usa colore scurito */
                                fontSize: '30px', 
                                fontWeight: 400
                            },
                            formatter: kFormatter,
                            offsetX: -15
                         },
                        axisBorder: {
                            show: false
                        },
                        axisTicks: {
                            show: false
                        },
                        tickAmount: 5
                    },
                    legend: {
                        show: false
                    },
                    tooltip: {
                        y: {
                            formatter: kFormatter
                        }
                    },
                    grid: {
                        borderColor: '#cccccc',
                        strokeDashArray: 0,
                        xaxis: {
                            lines: {
                                show: false
                            }
                        },
                        padding: {
                            left: 0,
                            right: 0
                        }
                    }
                };
            }
            

           // --- Funzione getDonutChartOptions aggiornata ---
            function getDonutChartOptions(series, labels) {
                
                // Calcola il totale per il formatter della legenda
                const total = series.reduce((a, b) => a + b, 0);
                
                return {
                    series: series,
                    labels: labels,
                    chart: {
                        type: 'donut',
                        height: 320, 
                        fontFamily: 'Nunito Sans, sans-serif'
                    },
                    // Ordine colori: [Utenti, Moderatori]
                    colors: [chartColors.user, chartColors.moderator], 
                    
                    dataLabels: {
                        enabled: false
                    },
                    
                    legend: {
                        show: true,
                        position: 'top', 
                        horizontalAlign: 'center',
                        offsetY: 5, 
                        fontSize: '20px', 
                        fontWeight: 700, 
                        labels: {
                            // --- MODIFICA 2: Blu etichette uniformato al blu "moderator" ---
                            colors: chartColors.moderator 
                        },
                        markers: {
                            width: 18, 
                            height: 18, 
                            radius: 3, 
                            // --- MODIFICA 3: Pallini abbassati (da 8 a 10) ---
                            offsetY: 10 
                        },
                        itemMargin: {
                            horizontal: 15,
                            vertical: 5
                        },
                        formatter: function (seriesName, opts) {
                            const percent = (series[opts.seriesIndex] / total * 100).toFixed(0);
                            // --- MODIFICA 1: Grigio valori uniformato al grigio "text" dei grafici ---
                            const grayColor = chartColors.text; // Era '#333333'
                            return `${seriesName} <span style="font-weight: 400; color: ${grayColor}; margin-left: 6px;">${percent}%</span>`;
                        }
                    },
                    
                    plotOptions: {
                        pie: {
                            offsetY: 20, 
                            donut: {
                                size: '65%', 
                                labels: {
                                    show: false 
                                }
                            }
                        }
                    },
                    
                    tooltip: {
                        y: {
                            formatter: kFormatter, 
                            title: {
                                formatter: function (seriesName) {
                                    return seriesName + ':';
                                }
                            }
                        },
                        fillSeriesColor: true 
                    },

                    states: {
                        hover: {
                            filter: {
                                type: 'none'
                            }
                        }
                    }
                };
            }


            // --- MODIFICA 2: Funzione downloadPNG aggiornata per accettare 'cropBottomPx' ---
            async function downloadPNG(elementIdToCapture, filename, buttonEl, cropBottomPx = 0) {
                const elementToCapture = document.getElementById(elementIdToCapture);
                if (!elementToCapture) {
                    showError("Elemento del grafico non trovato: #" + elementIdToCapture);
                    return;
                }
                
                const btnTextEl = buttonEl.querySelector('.btn-text');
                const originalText = btnTextEl.textContent;
                setButtonLoading(buttonEl, btnTextEl, "Generazione PNG...");

                try {
                    await new Promise(resolve => setTimeout(resolve, 300));

                    const canvas = await html2canvas(elementToCapture, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: false
                    });
                    
                    let dataUrl;

                    // Logica di ritaglio
                    if (cropBottomPx > 0 && canvas.height > cropBottomPx) {
                        const originalWidth = canvas.width;
                        const originalHeight = canvas.height;
                        const newHeight = originalHeight - cropBottomPx;

                        const croppedCanvas = document.createElement('canvas');
                        const ctx = croppedCanvas.getContext('2d');
                        
                        croppedCanvas.width = originalWidth;
                        croppedCanvas.height = newHeight;
                        
                        // Disegna l'immagine ritagliata (dall'angolo 0,0 fino alla nuova altezza)
                        ctx.drawImage(canvas, 0, 0, originalWidth, newHeight, 0, 0, originalWidth, newHeight);
                        
                        dataUrl = croppedCanvas.toDataURL('image/png');
                    } else {
                        // Comportamento originale se non c'è crop
                        dataUrl = canvas.toDataURL('image/png');
                    }
                    // Fine logica di ritaglio

                    const link = document.createElement('a');
                    link.href = dataUrl;
                    
                    const safeSheetName = (currentSheetName || 'grafico').replace(/ /g, '_');
                    link.download = `${safeSheetName}_${filename}`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    setButtonDone(buttonEl, btnTextEl, "Fatto!", originalText);

                } catch (err) {
                    console.error("Errore during l'esportazione PNG:", err);
                    showError("Impossibile generare il PNG. " + err.message);
                    setButtonError(buttonEl, btnTextEl, "Errore", originalText);
                }
            }
            
            // --- INIZIO MODIFICA (JS) 2: Funzione per copiare valore summary ---
            async function copySummaryValue(elementId, buttonEl) {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                const valueToCopy = element.textContent;
                if (valueToCopy === '-') return; // Non copiare il placeholder

                // Salva l'icona originale
                const originalIcon = buttonEl.innerHTML;
                
                // Icona di "check" (successo)
                const successIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-green-500">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                                     </svg>`;
                
                try {
                    // Usa la Clipboard API moderna
                    await navigator.clipboard.writeText(valueToCopy);
                    
                    // Mostra icona successo
                    buttonEl.innerHTML = successIcon;
                    buttonEl.disabled = true;

                    // Ripristina l'icona originale dopo 1.5 sec
                    setTimeout(() => {
                        buttonEl.innerHTML = originalIcon;
                        buttonEl.disabled = false;
                    }, 1500);

                } catch (err) {
                    console.error('Errore durante la copia del valore:', err);
                    // (Opzionale) Si potrebbe mostrare un'icona di errore
                }
            }
            // --- FINE MODIFICA (JS) 2 ---

            function copyTableToClipboard(tableId, buttonEl) {
                const table = document.getElementById(tableId);
                if (!table) return;
                
                const btnTextEl = buttonEl.querySelector('.btn-text');
                const originalText = btnTextEl.textContent;
                setButtonLoading(buttonEl, btnTextEl, "Copia in corso...");

                let tsv = '';
                for (const row of table.rows) {
                    const cells = Array.from(row.cells).map(cell => cell.innerText);
                    tsv += cells.join('\t') + '\n';
                }

                const textArea = document.createElement('textarea');
                textArea.value = tsv;
                textArea.style.position = 'absolute';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                
                textArea.select();
                try {
                    document.execCommand('copy');
                    setButtonDone(buttonEl, btnTextEl, "Copiato!", originalText);
                } catch (err) {
                    console.error("Errore during la copia:", err);
                    setButtonError(buttonEl, btnTextEl, "Errore", originalText);
                }

                document.body.removeChild(textArea);
            }

            function showError(message) {
                errorText.innerHTML = message;
                errorMessage.classList.remove('hidden');
            }

            function hideError() {
                errorMessage.classList.add('hidden');
                errorText.innerHTML = "";
            }

            function showSection(el) {
                el.classList.add('visible');
            }
            
            function hideSection(el) {
                el.classList.remove('visible');
            }

            function setButtonLoading(btnEl, textEl, loadingText) {
                textEl.textContent = loadingText;
                btnEl.disabled = true;
            }
            
            function setButtonDone(btnEl, textEl, doneText, originalText) {
                textEl.textContent = doneText;
                btnEl.disabled = false;
                setTimeout(() => {
                    textEl.textContent = originalText;
                }, 2000); 
            }
            
            function setButtonError(btnEl, textEl, errorText, originalText) {
                textEl.textContent = errorText;
                btnEl.disabled = false;
                setTimeout(() => {
                    textEl.textContent = originalText;
                }, 3000);
            }

        });
    </script>

</body>
</html>
